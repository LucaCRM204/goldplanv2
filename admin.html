<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoldPlan Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #D4AF37; --gold-dark: #B8960C; --black: #0a0a0a; --black-light: #141414; --black-lighter: #1e1e1e; --white: #ffffff; --gray: #888; --gray-dark: #333; --green: #22c55e; --red: #ef4444; --blue: #3b82f6; --purple: #8b5cf6; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: var(--black); color: var(--white); min-height: 100vh; }
        .login-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 2rem; }
        .login-box { background: var(--black-light); border: 1px solid var(--gray-dark); border-radius: 12px; padding: 3rem; width: 100%; max-width: 400px; }
        .login-box h1 { color: var(--gold); font-size: 1.8rem; margin-bottom: 0.5rem; text-align: center; }
        .login-box p { color: var(--gray); text-align: center; margin-bottom: 2rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--gray); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.9rem 1rem; background: var(--black-lighter); border: 1px solid var(--gray-dark); border-radius: 6px; color: var(--white); font-family: 'Poppins', sans-serif; font-size: 0.95rem; transition: border-color 0.3s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--gold); }
        .btn { padding: 1rem 2rem; border: none; border-radius: 6px; font-family: 'Poppins', sans-serif; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: var(--gold); color: var(--black); width: 100%; }
        .btn-primary:hover { background: var(--gold-dark); }
        .btn-secondary { background: var(--black-lighter); color: var(--white); border: 1px solid var(--gray-dark); }
        .btn-danger { background: var(--red); color: var(--white); }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.8rem; }
        .admin-panel { display: none; }
        .admin-panel.active { display: block; }
        .admin-header { background: var(--black-light); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--gray-dark); position: sticky; top: 0; z-index: 100; }
        .admin-logo { font-size: 1.3rem; font-weight: 700; color: var(--gold); }
        .admin-logo span { color: var(--white); font-weight: 400; }
        .admin-user { display: flex; align-items: center; gap: 1rem; }
        .admin-user span { color: var(--gray); font-size: 0.85rem; }
        .user-role { background: var(--purple); color: white; padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
        .user-role.admin { background: var(--blue); }
        .admin-container { display: flex; min-height: calc(100vh - 60px); }
        .sidebar { width: 250px; background: var(--black-light); border-right: 1px solid var(--gray-dark); padding: 1.5rem 0; }
        .sidebar-menu { list-style: none; }
        .sidebar-menu li a { display: flex; align-items: center; gap: 0.8rem; padding: 1rem 1.5rem; color: var(--gray); text-decoration: none; font-size: 0.9rem; transition: all 0.3s; border-left: 3px solid transparent; }
        .sidebar-menu li a:hover, .sidebar-menu li a.active { background: var(--black-lighter); color: var(--white); border-left-color: var(--gold); }
        .sidebar-menu li a.disabled { opacity: 0.4; pointer-events: none; display: none; }
        .main-content { flex: 1; padding: 2rem; overflow-y: auto; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .page-title { font-size: 1.5rem; font-weight: 600; }
        .page-title small { display: block; font-size: 0.85rem; color: var(--gray); font-weight: 400; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: var(--black-light); border: 1px solid var(--gray-dark); border-radius: 10px; padding: 1.5rem; }
        .stat-card .icon { font-size: 2rem; margin-bottom: 0.5rem; }
        .stat-card .value { font-size: 2rem; font-weight: 700; color: var(--gold); }
        .stat-card .label { color: var(--gray); font-size: 0.85rem; }
        .table-container { background: var(--black-light); border: 1px solid var(--gray-dark); border-radius: 10px; overflow: hidden; }
        .table-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid var(--gray-dark); }
        .table-header h3 { font-size: 1rem; font-weight: 600; }
        .table-search input { padding: 0.5rem 1rem; background: var(--black-lighter); border: 1px solid var(--gray-dark); border-radius: 6px; color: var(--white); font-size: 0.85rem; }
        .vehicles-table { width: 100%; border-collapse: collapse; }
        .vehicles-table th, .vehicles-table td { padding: 1rem 1.5rem; text-align: left; border-bottom: 1px solid var(--gray-dark); }
        .vehicles-table th { background: var(--black-lighter); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: var(--gray); }
        .vehicles-table tr:hover { background: var(--black-lighter); }
        .vehicle-cell { display: flex; align-items: center; gap: 1rem; }
        .vehicle-thumb { width: 60px; height: 45px; background: var(--black-lighter); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; overflow: hidden; }
        .vehicle-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .badge { padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.7rem; font-weight: 600; }
        .badge-superadmin { background: rgba(139, 92, 246, 0.2); color: var(--purple); }
        .badge-admin { background: rgba(59, 130, 246, 0.2); color: var(--blue); }
        .price-cell { font-weight: 600; color: var(--gold); }
        .btn-icon { width: 35px; height: 35px; border-radius: 6px; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; transition: all 0.3s; font-size: 1rem; }
        .btn-edit { background: rgba(59, 130, 246, 0.2); color: var(--blue); }
        .btn-edit:hover { background: var(--blue); color: var(--white); }
        .btn-delete { background: rgba(239, 68, 68, 0.2); color: var(--red); }
        .btn-delete:hover { background: var(--red); color: var(--white); }
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; padding: 2rem; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal.active { opacity: 1; visibility: visible; }
        .modal-content { background: var(--black-light); border: 1px solid var(--gray-dark); border-radius: 12px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; border-bottom: 1px solid var(--gray-dark); }
        .modal-header h3 { font-size: 1.1rem; font-weight: 600; }
        .modal-close { background: none; border: none; color: var(--gray); font-size: 1.5rem; cursor: pointer; }
        .modal-close:hover { color: var(--white); }
        .modal-body { padding: 1.5rem; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 1rem; padding: 1.5rem; border-top: 1px solid var(--gray-dark); }
        .image-upload { border: 2px dashed var(--gray-dark); border-radius: 8px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.3s; margin-bottom: 1rem; }
        .image-upload:hover { border-color: var(--gold); }
        .image-upload.has-image { padding: 0; border-style: solid; }
        .image-upload img { width: 100%; height: 200px; object-fit: cover; border-radius: 6px; }
        .image-upload .placeholder { color: var(--gray); }
        .image-upload .placeholder .icon { font-size: 3rem; margin-bottom: 0.5rem; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--gray-dark); padding-bottom: 0.5rem; overflow-x: auto; }
        .tab-btn { padding: 0.7rem 1.5rem; background: none; border: none; color: var(--gray); font-family: 'Poppins', sans-serif; font-size: 0.9rem; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.3s; white-space: nowrap; }
        .tab-btn:hover, .tab-btn.active { color: var(--gold); border-bottom-color: var(--gold); }
        .page-section { display: none; }
        .page-section.active { display: block; }
        .toast { position: fixed; bottom: 2rem; right: 2rem; padding: 1rem 1.5rem; border-radius: 8px; color: var(--white); font-size: 0.9rem; z-index: 10000; transform: translateY(100px); opacity: 0; transition: all 0.3s; }
        .toast.active { transform: translateY(0); opacity: 1; }
        .toast.success { background: var(--green); }
        .toast.error { background: var(--red); }
        .loading { text-align: center; padding: 3rem; color: var(--gray); }
        .user-avatar { width: 40px; height: 40px; background: var(--gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--black); }
        @media (max-width: 768px) { .sidebar { display: none; } .form-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1>üöó GoldPlan</h1>
            <p>Panel de Administraci√≥n</p>
            <form id="loginForm">
                <div class="form-group"><label>Usuario</label><input type="text" id="loginUser" required></div>
                <div class="form-group"><label>Contrase√±a</label><input type="password" id="loginPass" required></div>
                <button type="submit" class="btn btn-primary">Ingresar</button>
            </form>
        </div>
    </div>

    <div class="admin-panel" id="adminPanel">
        <header class="admin-header">
            <div class="admin-logo">GoldPlan <span>Admin</span></div>
            <div class="admin-user">
                <span id="welcomeUser">Hola, Admin</span>
                <span class="user-role" id="userRoleBadge">ADMIN</span>
                <button class="btn btn-secondary btn-sm" onclick="logout()">Salir</button>
            </div>
        </header>
        <div class="admin-container">
            <aside class="sidebar">
                <ul class="sidebar-menu">
                    <li><a href="#" class="active" data-page="dashboard"><span class="icon">üìä</span> Dashboard</a></li>
                    <li><a href="#" data-page="0km"><span class="icon">üöó</span> Veh√≠culos 0KM</a></li>
                    <li><a href="#" data-page="usados"><span class="icon">üöô</span> Veh√≠culos Usados</a></li>
                    <li><a href="#" data-page="config"><span class="icon">‚öôÔ∏è</span> Configuraci√≥n</a></li>
                    <li><a href="#" data-page="usuarios" id="menuUsuarios" class="disabled"><span class="icon">üë•</span> Usuarios</a></li>
                </ul>
            </aside>
            <main class="main-content">
                <section class="page-section active" id="pageDashboard">
                    <div class="page-header"><div class="page-title">Dashboard<small>Resumen general</small></div></div>
                    <div class="stats-grid">
                        <div class="stat-card"><div class="icon">üöó</div><div class="value" id="stat0km">0</div><div class="label">Veh√≠culos 0KM</div></div>
                        <div class="stat-card"><div class="icon">üöô</div><div class="value" id="statUsados">0</div><div class="label">Veh√≠culos Usados</div></div>
                        <div class="stat-card"><div class="icon">üì∏</div><div class="value" id="statFotos">0</div><div class="label">Fotos cargadas</div></div>
                        <div class="stat-card"><div class="icon">üë•</div><div class="value" id="statUsuarios">0</div><div class="label">Usuarios</div></div>
                    </div>
                </section>
                <section class="page-section" id="page0km">
                    <div class="page-header"><div class="page-title">Veh√≠culos 0KM<small>Gestionar precios y fotos</small></div></div>
                    <div class="tabs">
                        <button class="tab-btn active" data-brand="todos">Todos</button>
                        <button class="tab-btn" data-brand="volkswagen">Volkswagen</button>
                        <button class="tab-btn" data-brand="fiat">Fiat</button>
                        <button class="tab-btn" data-brand="peugeot">Peugeot</button>
                        <button class="tab-btn" data-brand="renault">Renault</button>
                    </div>
                    <div class="table-container">
                        <div class="table-header"><h3>Inventario 0KM</h3><div class="table-search"><input type="text" placeholder="Buscar..." id="search0km"></div></div>
                        <table class="vehicles-table"><thead><tr><th>Veh√≠culo</th><th>Marca</th><th>Precio</th><th>Plan</th><th>Acciones</th></tr></thead><tbody id="table0km"><tr><td colspan="5" class="loading">Cargando...</td></tr></tbody></table>
                    </div>
                </section>
                <section class="page-section" id="pageUsados">
                    <div class="page-header"><div class="page-title">Veh√≠culos Usados<small>Agregar y gestionar usados</small></div><button class="btn btn-primary" onclick="openUsadoModal()">+ Agregar Usado</button></div>
                    <div class="table-container">
                        <div class="table-header"><h3>Inventario Usados</h3></div>
                        <table class="vehicles-table"><thead><tr><th>Veh√≠culo</th><th>A√±o</th><th>Km</th><th>Precio</th><th>Acciones</th></tr></thead><tbody id="tableUsados"><tr><td colspan="5" class="loading">Cargando...</td></tr></tbody></table>
                    </div>
                </section>
                <section class="page-section" id="pageConfig">
                    <div class="page-header"><div class="page-title">Configuraci√≥n<small>Ajustes generales</small></div></div>
                    <div class="table-container" style="padding: 2rem;">
                        <h3 style="margin-bottom: 1.5rem;">Datos de Contacto</h3>
                        <div class="form-group"><label>WhatsApp</label><input type="text" id="configWhatsapp" value="+54 9 11 7857-4747"></div>
                        <div class="form-group"><label>Tel√©fono</label><input type="text" id="configTelefono" value="+54 9 11 7857-4747"></div>
                        <div class="form-group"><label>Horarios</label><input type="text" id="configHorarios" value="Lunes a S√°bados: 09:30 a 19:00hs"></div>
                        <button class="btn btn-primary" onclick="saveConfig()">Guardar Cambios</button>
                    </div>
                </section>
                <section class="page-section" id="pageUsuarios">
                    <div class="page-header"><div class="page-title">Gesti√≥n de Usuarios<small>Crear y eliminar usuarios</small></div><button class="btn btn-primary" onclick="openUserModal()">+ Nuevo Usuario</button></div>
                    <div class="table-container">
                        <table class="vehicles-table"><thead><tr><th>Usuario</th><th>Nombre</th><th>Rol</th><th>Acciones</th></tr></thead><tbody id="tableUsuarios"><tr><td colspan="4" class="loading">Cargando...</td></tr></tbody></table>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <div class="modal" id="modal0km">
        <div class="modal-content">
            <div class="modal-header"><h3>Editar Veh√≠culo 0KM</h3><button class="modal-close" onclick="closeModal('modal0km')">‚úï</button></div>
            <div class="modal-body">
                <input type="hidden" id="edit0kmId">
                <div class="image-upload" id="imageUpload0km" onclick="document.getElementById('imageInput0km').click()"><div class="placeholder"><div class="icon">üì∑</div><div>Click para subir imagen</div></div></div>
                <input type="file" id="imageInput0km" accept="image/*" style="display:none" onchange="previewImage(this, 'imageUpload0km')">
                <div class="form-group"><label>Nombre</label><input type="text" id="edit0kmName" readonly></div>
                <div class="form-row">
                    <div class="form-group"><label>Precio</label><input type="text" id="edit0kmPrice"></div>
                    <div class="form-group"><label>Plan</label><input type="text" id="edit0kmPlan"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Anticipo</label><input type="text" id="edit0kmAnticipo"></div>
                    <div class="form-group"><label>Cuota</label><input type="text" id="edit0kmCuota"></div>
                </div>
                <div class="form-group"><label>Descripci√≥n</label><textarea id="edit0kmDesc" rows="3"></textarea></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal0km')">Cancelar</button><button class="btn btn-primary" onclick="save0km()">Guardar</button></div>
        </div>
    </div>

    <div class="modal" id="modalUsado">
        <div class="modal-content">
            <div class="modal-header"><h3 id="modalUsadoTitle">Agregar Usado</h3><button class="modal-close" onclick="closeModal('modalUsado')">‚úï</button></div>
            <div class="modal-body">
                <input type="hidden" id="editUsadoId">
                <div class="image-upload" id="imageUploadUsado" onclick="document.getElementById('imageInputUsado').click()"><div class="placeholder"><div class="icon">üì∑</div><div>Click para subir imagen</div></div></div>
                <input type="file" id="imageInputUsado" accept="image/*" style="display:none" onchange="previewImage(this, 'imageUploadUsado')">
                <div class="form-row">
                    <div class="form-group"><label>Marca</label><select id="editUsadoMarca"><option value="volkswagen">Volkswagen</option><option value="fiat">Fiat</option><option value="peugeot">Peugeot</option><option value="renault">Renault</option><option value="chevrolet">Chevrolet</option><option value="ford">Ford</option><option value="toyota">Toyota</option><option value="otro">Otro</option></select></div>
                    <div class="form-group"><label>Modelo</label><input type="text" id="editUsadoModelo"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>A√±o</label><input type="number" id="editUsadoYear"></div>
                    <div class="form-group"><label>Kil√≥metros</label><input type="text" id="editUsadoKm"></div>
                </div>
                <div class="form-group"><label>Precio</label><input type="text" id="editUsadoPrice"></div>
                <div class="form-group"><label>Descripci√≥n</label><textarea id="editUsadoDesc" rows="3"></textarea></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modalUsado')">Cancelar</button><button class="btn btn-danger" id="btnDeleteUsado" onclick="deleteUsado()" style="display:none">Eliminar</button><button class="btn btn-primary" onclick="saveUsado()">Guardar</button></div>
        </div>
    </div>

    <div class="modal" id="modalUser">
        <div class="modal-content">
            <div class="modal-header"><h3 id="modalUserTitle">Nuevo Usuario</h3><button class="modal-close" onclick="closeModal('modalUser')">‚úï</button></div>
            <div class="modal-body">
                <input type="hidden" id="editUserId">
                <div class="form-group"><label>Usuario</label><input type="text" id="editUserUsername"></div>
                <div class="form-group"><label>Nombre</label><input type="text" id="editUserName"></div>
                <div class="form-group"><label>Contrase√±a</label><input type="password" id="editUserPass"></div>
                <div class="form-group"><label>Rol</label><select id="editUserRole"><option value="admin">Admin</option><option value="superadmin">Superadmin</option></select></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modalUser')">Cancelar</button><button class="btn btn-primary" onclick="saveUser()">Guardar</button></div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const API_URL = 'https://goldplan-production.up.railway.app/api';
        let token = localStorage.getItem('goldplan_token');
        let currentUser = JSON.parse(localStorage.getItem('goldplan_user') || 'null');
        let vehicles0km = [], vehiclesUsados = [], users = [];

        // API Helper
        async function api(endpoint, options = {}) {
            const headers = { 'Content-Type': 'application/json' };
            if (token) headers['Authorization'] = `Bearer ${token}`;
            try {
                const res = await fetch(`${API_URL}${endpoint}`, { ...options, headers });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Error');
                return data;
            } catch (err) {
                if (err.message.includes('Token')) { logout(); }
                throw err;
            }
        }

        // Auth
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const data = await api('/login', {
                    method: 'POST',
                    body: JSON.stringify({ username: document.getElementById('loginUser').value, password: document.getElementById('loginPass').value })
                });
                token = data.token;
                currentUser = data.user;
                localStorage.setItem('goldplan_token', token);
                localStorage.setItem('goldplan_user', JSON.stringify(currentUser));
                showAdminPanel();
                showToast('Bienvenido ' + currentUser.name, 'success');
            } catch (err) { showToast(err.message, 'error'); }
        });

        function logout() {
            token = null; currentUser = null;
            localStorage.removeItem('goldplan_token');
            localStorage.removeItem('goldplan_user');
            document.getElementById('adminPanel').classList.remove('active');
            document.getElementById('loginScreen').style.display = 'flex';
        }

        async function showAdminPanel() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminPanel').classList.add('active');
            document.getElementById('welcomeUser').textContent = `Hola, ${currentUser.name.split(' ')[0]}`;
            const badge = document.getElementById('userRoleBadge');
            badge.textContent = currentUser.role.toUpperCase();
            badge.className = currentUser.role === 'superadmin' ? 'user-role' : 'user-role admin';
            document.getElementById('menuUsuarios').classList.toggle('disabled', currentUser.role !== 'superadmin');
            await loadData();
        }

        async function loadData() {
            try {
                vehicles0km = await api('/vehicles/0km');
                vehiclesUsados = await api('/vehicles/usados');
                if (currentUser.role === 'superadmin') users = await api('/users');
                const config = await api('/config');
                if (config.whatsapp) document.getElementById('configWhatsapp').value = config.whatsapp;
                if (config.telefono) document.getElementById('configTelefono').value = config.telefono;
                if (config.horarios) document.getElementById('configHorarios').value = config.horarios;
                renderDashboard();
                render0kmTable();
                renderUsadosTable();
                if (currentUser.role === 'superadmin') renderUsersTable();
            } catch (err) { console.error(err); }
        }

        // Dashboard
        function renderDashboard() {
            document.getElementById('stat0km').textContent = vehicles0km.length;
            document.getElementById('statUsados').textContent = vehiclesUsados.length;
            document.getElementById('statFotos').textContent = vehicles0km.filter(v => v.image).length + vehiclesUsados.filter(v => v.image).length;
            document.getElementById('statUsuarios').textContent = users.length || '-';
        }

        // 0KM
        function render0kmTable(filter = 'todos') {
            const filtered = filter === 'todos' ? vehicles0km : vehicles0km.filter(v => v.brand === filter);
            document.getElementById('table0km').innerHTML = filtered.length ? filtered.map(v => `
                <tr>
                    <td><div class="vehicle-cell"><div class="vehicle-thumb">${v.image ? `<img src="${v.image}">` : 'üöó'}</div><div><strong>${v.name}</strong><br><small style="color:var(--gray)">${v.image ? '‚úÖ' : '‚ö†Ô∏è'} Foto</small></div></div></td>
                    <td style="text-transform:capitalize">${v.brand}</td>
                    <td class="price-cell">${v.price}</td>
                    <td>${v.plan}</td>
                    <td><button class="btn-icon btn-edit" onclick="edit0km(${v.id})">‚úèÔ∏è</button></td>
                </tr>
            `).join('') : '<tr><td colspan="5" class="loading">No hay veh√≠culos</td></tr>';
        }

        document.querySelectorAll('#page0km .tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#page0km .tab-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                render0kmTable(this.dataset.brand);
            });
        });

        function edit0km(id) {
            const v = vehicles0km.find(x => x.id === id);
            document.getElementById('edit0kmId').value = id;
            document.getElementById('edit0kmName').value = v.name;
            document.getElementById('edit0kmPrice').value = v.price || '';
            document.getElementById('edit0kmPlan').value = v.plan || '';
            document.getElementById('edit0kmAnticipo').value = v.anticipo || '';
            document.getElementById('edit0kmCuota').value = v.cuota || '';
            document.getElementById('edit0kmDesc').value = v.description || '';
            const upload = document.getElementById('imageUpload0km');
            if (v.image) { upload.innerHTML = `<img src="${v.image}">`; upload.classList.add('has-image'); }
            else { upload.innerHTML = '<div class="placeholder"><div class="icon">üì∑</div><div>Click para subir</div></div>'; upload.classList.remove('has-image'); }
            openModal('modal0km');
        }

        async function save0km() {
            const id = document.getElementById('edit0kmId').value;
            const img = document.getElementById('imageUpload0km').querySelector('img');
            try {
                await api(`/vehicles/0km/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        price: document.getElementById('edit0kmPrice').value,
                        plan: document.getElementById('edit0kmPlan').value,
                        anticipo: document.getElementById('edit0kmAnticipo').value,
                        cuota: document.getElementById('edit0kmCuota').value,
                        description: document.getElementById('edit0kmDesc').value,
                        image: img ? img.src : null
                    })
                });
                closeModal('modal0km');
                await loadData();
                showToast('Veh√≠culo actualizado', 'success');
            } catch (err) { showToast(err.message, 'error'); }
        }

        // Usados
        function renderUsadosTable() {
            document.getElementById('tableUsados').innerHTML = vehiclesUsados.length ? vehiclesUsados.map(v => `
                <tr>
                    <td><div class="vehicle-cell"><div class="vehicle-thumb">${v.image ? `<img src="${v.image}">` : 'üöô'}</div><div><strong>${v.modelo}</strong><br><small style="color:var(--gray);text-transform:capitalize">${v.brand}</small></div></div></td>
                    <td>${v.year}</td>
                    <td>${v.km}</td>
                    <td class="price-cell">${v.price}</td>
                    <td><button class="btn-icon btn-edit" onclick="editUsado(${v.id})">‚úèÔ∏è</button><button class="btn-icon btn-delete" onclick="confirmDeleteUsado(${v.id})">üóëÔ∏è</button></td>
                </tr>
            `).join('') : '<tr><td colspan="5" class="loading">No hay usados. Agreg√° uno!</td></tr>';
        }

        function openUsadoModal(id = null) {
            document.getElementById('editUsadoId').value = id || '';
            document.getElementById('modalUsadoTitle').textContent = id ? 'Editar Usado' : 'Agregar Usado';
            document.getElementById('btnDeleteUsado').style.display = id ? 'block' : 'none';
            if (id) {
                const v = vehiclesUsados.find(x => x.id === id);
                document.getElementById('editUsadoMarca').value = v.brand;
                document.getElementById('editUsadoModelo').value = v.modelo;
                document.getElementById('editUsadoYear').value = v.year;
                document.getElementById('editUsadoKm').value = v.km;
                document.getElementById('editUsadoPrice').value = v.price;
                document.getElementById('editUsadoDesc').value = v.description || '';
                const upload = document.getElementById('imageUploadUsado');
                if (v.image) { upload.innerHTML = `<img src="${v.image}">`; upload.classList.add('has-image'); }
                else resetImageUpload('imageUploadUsado');
            } else {
                ['editUsadoMarca','editUsadoModelo','editUsadoYear','editUsadoKm','editUsadoPrice','editUsadoDesc'].forEach(id => document.getElementById(id).value = '');
                document.getElementById('editUsadoMarca').value = 'volkswagen';
                resetImageUpload('imageUploadUsado');
            }
            openModal('modalUsado');
        }

        function editUsado(id) { openUsadoModal(id); }

        async function saveUsado() {
            const id = document.getElementById('editUsadoId').value;
            const img = document.getElementById('imageUploadUsado').querySelector('img');
            const data = {
                brand: document.getElementById('editUsadoMarca').value,
                modelo: document.getElementById('editUsadoModelo').value,
                year: parseInt(document.getElementById('editUsadoYear').value),
                km: document.getElementById('editUsadoKm').value,
                price: document.getElementById('editUsadoPrice').value,
                description: document.getElementById('editUsadoDesc').value,
                image: img ? img.src : null
            };
            try {
                if (id) await api(`/vehicles/usados/${id}`, { method: 'PUT', body: JSON.stringify(data) });
                else await api('/vehicles/usados', { method: 'POST', body: JSON.stringify(data) });
                closeModal('modalUsado');
                await loadData();
                showToast(id ? 'Actualizado' : 'Agregado', 'success');
            } catch (err) { showToast(err.message, 'error'); }
        }

        function confirmDeleteUsado(id) { if (confirm('¬øEliminar este veh√≠culo?')) deleteUsado(id); }
        async function deleteUsado(id = null) {
            const delId = id || document.getElementById('editUsadoId').value;
            try {
                await api(`/vehicles/usados/${delId}`, { method: 'DELETE' });
                closeModal('modalUsado');
                await loadData();
                showToast('Eliminado', 'success');
            } catch (err) { showToast(err.message, 'error'); }
        }

        // Users
        function renderUsersTable() {
            document.getElementById('tableUsuarios').innerHTML = users.map(u => `
                <tr>
                    <td><div class="vehicle-cell"><div class="user-avatar">${u.name.charAt(0)}</div><div><strong>${u.username}</strong></div></div></td>
                    <td>${u.name}</td>
                    <td><span class="badge ${u.role === 'superadmin' ? 'badge-superadmin' : 'badge-admin'}">${u.role.toUpperCase()}</span></td>
                    <td><button class="btn-icon btn-edit" onclick="editUser(${u.id})">‚úèÔ∏è</button>${u.username !== 'Luca.Caorsi' ? `<button class="btn-icon btn-delete" onclick="confirmDeleteUser(${u.id})">üóëÔ∏è</button>` : ''}</td>
                </tr>
            `).join('');
        }

        function openUserModal(id = null) {
            document.getElementById('editUserId').value = id || '';
            document.getElementById('modalUserTitle').textContent = id ? 'Editar Usuario' : 'Nuevo Usuario';
            if (id) {
                const u = users.find(x => x.id === id);
                document.getElementById('editUserUsername').value = u.username;
                document.getElementById('editUserName').value = u.name;
                document.getElementById('editUserPass').value = '';
                document.getElementById('editUserRole').value = u.role;
            } else {
                ['editUserUsername','editUserName','editUserPass'].forEach(id => document.getElementById(id).value = '');
                document.getElementById('editUserRole').value = 'admin';
            }
            openModal('modalUser');
        }

        function editUser(id) { openUserModal(id); }

        async function saveUser() {
            const id = document.getElementById('editUserId').value;
            const data = {
                username: document.getElementById('editUserUsername').value,
                name: document.getElementById('editUserName').value,
                password: document.getElementById('editUserPass').value,
                role: document.getElementById('editUserRole').value
            };
            if (!id && !data.password) { showToast('Contrase√±a requerida', 'error'); return; }
            try {
                if (id) await api(`/users/${id}`, { method: 'PUT', body: JSON.stringify(data) });
                else await api('/users', { method: 'POST', body: JSON.stringify(data) });
                closeModal('modalUser');
                await loadData();
                showToast(id ? 'Actualizado' : 'Creado', 'success');
            } catch (err) { showToast(err.message, 'error'); }
        }

        function confirmDeleteUser(id) { if (confirm('¬øEliminar usuario?')) deleteUser(id); }
        async function deleteUser(id) {
            try {
                await api(`/users/${id}`, { method: 'DELETE' });
                await loadData();
                showToast('Eliminado', 'success');
            } catch (err) { showToast(err.message, 'error'); }
        }

        // Config
        async function saveConfig() {
            try {
                await api('/config', {
                    method: 'POST',
                    body: JSON.stringify({
                        whatsapp: document.getElementById('configWhatsapp').value,
                        telefono: document.getElementById('configTelefono').value,
                        horarios: document.getElementById('configHorarios').value
                    })
                });
                showToast('Configuraci√≥n guardada', 'success');
            } catch (err) { showToast(err.message, 'error'); }
        }

        // Navigation
        document.querySelectorAll('.sidebar-menu a').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                if (this.classList.contains('disabled')) return;
                document.querySelectorAll('.sidebar-menu a').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
                document.getElementById('page' + this.dataset.page.charAt(0).toUpperCase() + this.dataset.page.slice(1)).classList.add('active');
            });
        });

        // Utils
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'toast ' + type + ' active';
            setTimeout(() => toast.classList.remove('active'), 3000);
        }
        function previewImage(input, uploadId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    const upload = document.getElementById(uploadId);
                    upload.innerHTML = `<img src="${e.target.result}">`;
                    upload.classList.add('has-image');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        function resetImageUpload(id) {
            const upload = document.getElementById(id);
            upload.innerHTML = '<div class="placeholder"><div class="icon">üì∑</div><div>Click para subir</div></div>';
            upload.classList.remove('has-image');
        }

        // Init
        if (token && currentUser) showAdminPanel();
    </script>
</body>
</html>
